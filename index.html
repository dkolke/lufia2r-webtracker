<!doctype html><!--
	Lufia 2 Randomizer Webtracker
	Made by PhilAndChill (c) 2023
	https://github.com/phku-hk
	See LICENSE file
	Credits to holysmith, Deln and dank_meats for tracker data and images.
--><html data-bs-theme="dark">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
	<meta name="color-scheme" content="light dark">
	<meta property="og:type" content="website">
	<meta property="og:url" content="">
	<meta property="og:title" content="Lufia 2 Randomizer Webtracker">
	<meta property="og:description" content="Tracking your progress">
	<meta property="og:image" content="preview.jpg">
	<title>Lufia 2 Randomizer Webtracker</title>
	<link rel="icon" href="favicon.png" type="image/png"/>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark-plugin.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
	<style>
		.collectible {
			width:32px;
			height:32px;
			cursor:pointer;
			filter: brightness(.3);
		}
		.on {
			filter: brightness(1);
		}
		.spacer {
			width:32px;
		}
		.pointer {
			cursor:pointer;
		}
		.badge-grid {
			display: flex;
			flex-direction: column;
			flex-wrap: wrap;
			align-items: center;
			min-height: 8rem;
			max-height: 8rem;
			width: 70%;
			row-gap: 5px;
			column-gap: 5px;
			align-content: center;
		}
		.badge-item {
			width: 12rem;
		}
	</style>
</head>
<body>
	<center>
		<h2>Lufia 2 Randomizer Webtracker</h2>
		<img class="collectible" name="arrow" src="Lufia2/images/item/arrow.png" title="Arrow"/>
		<img class="collectible" name="firearrow" src="Lufia2/images/item/firearrow.png" title="Fire Arrow"/>
		<img class="collectible" name="bomb" src="Lufia2/images/item/Bomb.png" title="Bomb"/>
		<img class="collectible" name="hook" src="Lufia2/images/item/hook.png" title="Hook"/>
		<img class="collectible" name="hammer" src="Lufia2/images/item/chainball.png" title="Hammer"/>
		<img class="collectible" name="mermaid" src="Lufia2/images/item/mermaid_jade.png" title="Mermaid Jade"/>
		<img class="collectible" name="engine" src="Lufia2/images/item/engine.png" title="Engine"/>
		<div class="p-1"></div>
		<img class="collectible" name="lisa" src="Lufia2/images/item/lisa.png" title="Lisa"/>
		<img class="collectible" name="marie" src="Lufia2/images/item/lisa.png" title="Marie"/>
		<img class="collectible" name="claire" src="Lufia2/images/item/lisa.png" title="Claire"/>
		<img class="spacer"/>
		<img class="collectible" name="l_key" src="Lufia2/images/item/lake_key.png" title="Lake Key"/>
		<img class="collectible" name="ruby_key" src="Lufia2/images/item/ruby_key.png" title="Ruby Key"/>
		<img class="collectible" name="d_key" src="Lufia2/images/item/dankirk_key.png" title="Dankirk Key"/>
		<img class="collectible" name="b_key" src="Lufia2/images/item/basement_key.png" title="Basement Key"/>
		<div class="p-1"></div>
		<img class="collectible" name="sw_key" src="Lufia2/images/item/sword_key.png" title="Sword Key"/>
		<img class="collectible" name="h_key" src="Lufia2/images/item/heart_key.png" title="Heart Key"/>
		<img class="collectible" name="g_key" src="Lufia2/images/item/ghost_key.png" title="Ghost Key"/>
		<img class="spacer"/>
		<img class="collectible" name="tree_key" src="Lufia2/images/item/tree_key.png" title="Tree Key"/>
		<img class="collectible" name="flower_key" src="Lufia2/images/item/Flower_key.png" title="Flower Key"/>
		<img class="collectible" name="m_key" src="Lufia2/images/item/Magma_key.png" title="Magma Key"/>
		<div class="p-1"></div>
		<img class="collectible" name="c_key" src="Lufia2/images/item/cloud_key.png" title="Cloud Key"/>
		<img class="collectible" name="li_key" src="Lufia2/images/item/light_key.png" title="Light Key"/>
		<img class="collectible" name="n_key" src="Lufia2/images/item/narcysus_key.png" title="Narcysus Key"/>
		<img class="collectible" name="s_key" src="Lufia2/images/item/sky_key.png" title="Sky Key"/>
		<img class="collectible" name="tri_key" src="Lufia2/images/item/trial_key.png" title="Trial Key"/>
		<img class="collectible" name="tr_key" src="Lufia2/images/item/truth_key.png" title="Truth Key"/>
		<img class="collectible" name="w_key" src="Lufia2/images/item/wind_key.png" title="Wind Key"/>
		<div class="p-4">To be checked:</div>
		<div class="badge-grid" id="tobechecked"></div>
		<div class="p-4">Done:</div>
		<div class="badge-grid" id="done"></div>
		<div style="width: 90%" class="row">
			<div class="col-md-3"></div>
			<div class="col-md-3">
				<div class="p-4">Character Locations:</div>
				<img src="Lufia2/images/character/maxim.png"/> <select name="maxim" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/tia.png"/> <select name="tia" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/guy.png"/> <select name="guy" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/selan.png"/> <select name="selan" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/dekar.png"/> <select name="dekar" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/lexis.png"/> <select name="lexis" class="loca"><option>- / -</option></select><br/>
				<img src="Lufia2/images/character/arty.png"/> <select name="arty" class="loca"><option>- / -</option></select><br/>
			</div>
			<div class="col-md-3">
				<div class="p-4">Notes:</div>
				<textarea id="notes" style="height: 10rem"></textarea>
			</div>
			<div class="col-md-3"></div>
		</div>
		<button id="resetButton" type="button" class="btn btn-secondary btn-sm" >Reset</button>
	</center>
	<script>
		const LOCATION_KEY = "lufia2r-webtracker-locations";
		const CHARACTER_KEY = "lufia2r-webtracker-characters";
		const KEYITEMS_KEY = "lufia2r-webtracker-keyitems";
		const NOTES_KEY = "lufia2r-webtracker-notes";
		tracker = {
			locations: {},
			keyitems: {},
			notes: "",
			characterLocations: {},
			load: async data => {
				const loadedLocations = JSON.parse(localStorage.getItem(LOCATION_KEY))
				if(loadedLocations) {
					tracker.locations = loadedLocations
				} else {
					tracker.locations = await data.json()
				}
				Object.keys(tracker.locations).forEach( k => {
					$(".loca").each( (i,e) => {
						e.innerHTML += "<option>" + k + "</option>"
					})
				})

				const loadedCharacters = JSON.parse(localStorage.getItem(CHARACTER_KEY))
				if(loadedCharacters) {
					tracker.characterLocations = loadedCharacters
					$(".loca").each( (i,e) => {
						const character = loadedCharacters.find(c => c.name === e.name)
						if(character && character.location !== "- / -") {
							$(e).val(character.location)
						}
					})					
				} else {
					tracker.characterLocations = []
					$(".loca").each( (i,e) => {
						tracker.characterLocations.push({ "name": e.name, "location": "- / -" })
					})							
				}

				const loadedKeyitems = JSON.parse(localStorage.getItem(KEYITEMS_KEY))

				if(loadedKeyitems) {
					tracker.keyitems = loadedKeyitems
				} else {
					tracker.keyitems = []
					$("img[class^=collectible").each( (i,e) => {
						tracker.keyitems.push( { "name": e.name, "owned": false })
					})
				}

				const loadedNotes = JSON.parse(localStorage.getItem(NOTES_KEY))
				if(loadedNotes) {
					tracker.notes = loadedNotes
					$("#notes").val(loadedNotes)
				} 
				tracker.update()
			},
			toggleDone: k => {
				tracker.locations[k].done = ! tracker.locations[k].done
				tracker.update()
				tracker.save()
			},
			toggleOwned: n => {
				const item = tracker.keyitems.find(ki => ki.name === n)
				if(item) item.owned = ! item.owned
				tracker.update()
				tracker.save()
			},
			characterSelected: (k, v) => {
				const character = tracker.characterLocations.find(c => c.name === k)
				if(character) character.location = v
				tracker.save()
			},
			reset: () => {
				Object.keys(tracker.locations).forEach( k => {
					tracker.locations[k].done = false
				})
				tracker.keyitems.forEach(ki => ki.owned = false)
				$(".loca").each( (i,e) => {
						$(e).val("- / -")
					})		
				$("#notes").val("")
				tracker.update()
			},
			update: () => {
				$("img[class^=collectible").each( (i,e) => {
					const item = tracker.keyitems.find(ki => ki.name === e.name)
					if(item) {
						if(item.owned === true) $(e).addClass("on")
						if(item.owned === false) $(e).removeClass("on")
					}
				})
				var openChecks = []
				var doneChecks = []

				Object.keys(tracker.locations).forEach( k => {
					var loc = tracker.locations[k]
					var a = loc.access_rules
					if( loc.done )
						doneChecks.push(k)
					else if( a.length == 0 )
						openChecks.push({
							name: k,
							timeCost: loc.timeCost,
						})
					else {
						for( var i = 0; i < a.length; i++ ) {
							if( a[i].split(',')
								.every( v => tracker.keyitems.find(ki => ki.name === v).owned === true )) 
							{
								openChecks.push({
									name: k,
									timeCost: loc.timeCost,
								})
								break
							}
						}
					}
				})
				var openElems = ""
				openChecks
					.sort( (a,b) => (a.name > b.name) )
					.sort( (a,b) => (a.timeCost > b.timeCost) )
					.forEach( a => {
						var color = "background-color: "
						if(a.timeCost === 0) {
							color += "#f7cd11"
						} else if(a.timeCost <= 2) {
							color += "#0b992e"
						} else if(a.timeCost <= 4) {
							color += "#0ab6c9"
						} else if(a.timeCost <= 5) {
							color += "#0a77c9"
						} else if(a.timeCost <= 10) {
							color += "#730aa3"
						} else if(a.timeCost <= 15) {
							color += "#d10f0f"
						} else if(a.timeCost <= 20) {
							color += "#a30303"
						}

						openElems += "<span style=\""+ color +"\" class=\"badge pointer badge-item \" onclick=\"tracker.toggleDone('" + a.name + "')\">" 
							+ "(" + a.timeCost + ") " + a.name + "</span>"
					})
				$("#tobechecked").html(openElems)
				var doneElems = ""
				doneChecks.forEach( a => {
					doneElems += "<span class=\"badge bg-secondary pointer badge-item \" onclick=\"tracker.toggleDone('" + a + "')\">" + a + "</span>"
				})
				$("#done").html(doneElems)
			},
			save: () => {
				localStorage.setItem(NOTES_KEY, JSON.stringify(tracker.notes))
				localStorage.setItem(CHARACTER_KEY, JSON.stringify(tracker.characterLocations))
				localStorage.setItem(LOCATION_KEY, JSON.stringify(tracker.locations))
				localStorage.setItem(KEYITEMS_KEY, JSON.stringify(tracker.keyitems))
			},
			deleteData: () => {
				localStorage.removeItem(NOTES_KEY)
				localStorage.removeItem(CHARACTER_KEY)
				localStorage.removeItem(LOCATION_KEY)
				localStorage.removeItem(KEYITEMS_KEY)				
			}
		}
		$( () => {
			$("img[class^=collectible").click( e => {
				$(e.currentTarget).toggleClass("on")
				tracker.toggleOwned(e.currentTarget.name)
			})
			$("select[class^=loca]").change( e => {
				tracker.characterSelected(e.currentTarget.name, e.currentTarget.value)
			})
			$("#resetButton").click( e => {
				tracker.deleteData()
				tracker.reset()
				tracker.update()
			})
			$("#notes").bind('input propertychange', function() {
				if(this.value.length){
					tracker.notes = this.value
					tracker.save()
				}
			})
			fetch("data/locations.json").then(tracker.load)
		})
	</script>
</body>
</html>
